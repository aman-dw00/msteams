<source>
  @type tail                       # Tails log files
  path /var/log/sample.log         # Absolute path to log file
  pos_file /fluentd/buffer/sample.pos  # Tracks read position (survives restarts)
  tag sample.log                   # Assigns this tag to all logs
  format none                      # Treats lines as raw text (no parsing)
  refresh_interval 10s             # Check for file rotation every 10s
</source>

<filter sample.log>                # Processes logs with tag 'sample.log'
  @type record_transformer         # Modifies log records
  <record>
    host "#{Socket.gethostname}"   # Adds hostname field (used as Loki label)
    fluentd_worker $worker_id      # Adds worker process ID (use cautiously)
    stream_id "#{rand(1000000)}"
  </record>
</filter>

<source>
  @type tail
  path /var/log/sample_json.log
  pos_file /fluentd/buffer/sample_json.pos
  tag sample.json
  format json
  time_key time
  time_type string
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  refresh_interval 10s
</source>

<filter sample.json>
  @type record_transformer
  <record>
    host "#{Socket.gethostname}"
    log_type "json"
    stream_id "#{rand(1000000)}"
  </record>
</filter>

<match sample.**>
  @type forward

  <server>
    name aggregator1
    host fluentd-aggregator1
    port 24224
  </server>
  <server>
    name aggregator2
    host fluentd-aggregator2
    port 24224
  </server>

  <buffer>
    @type file
    path /fluentd/buffer/forward
    flush_interval 1s
    chunk_limit_size 1m
    total_limit_size 500m
    retry_forever true
    overflow_action block
  </buffer>

  load_balancer_type roundrobin
</match>
